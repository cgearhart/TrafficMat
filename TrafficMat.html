<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
        <link rel="stylesheet" type="text/css" href="http://code.jquery.com/ui/1.9.2/themes/base/jquery-ui.css">
        <!--<script type="text/javascript"
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyACj6bDj9hZuw13tovs7M5DjkQuKPq7qfw&sensor=true">
        </script>-->
        <script src="http://maps.google.com/maps/api/js?sensor=false"></script>
        <script type="text/javascript" src="http://code.jquery.com/jquery-1.8.3.js"></script>
        <script type="text/javascript" src="http://code.jquery.com/ui/1.9.2/jquery-ui.js"></script>
        <script type="text/javascript">
            if (navigator.geolocation) {
                console.log("Browser claims to support geolocation.")
                var timeoutVal = 10000;
                navigator.geolocation.getCurrentPosition(
                    foundLocation, 
                    displayError,
                    { enableHighAccuracy: true, timeout: timeoutVal, maximumAge: 0 }
                );    
            }
            else {
                console.log("Geolocation is not supported by this browser");
            }


            function foundLocation(position) {
                console.log(position.coords)
                var location = new google.maps.LatLng(position.coords.latitude,
                                                      position.coords.longitude);
                var newOpts = { 
                    center: location,
                    zoom: map.getZoom(),
                    disableDefaultUI: false, 
                    disableDoubleClickZoom: false,
                    draggable: true
                };

                updateMap(newOpts);
            }


            function displayError(error) {
                var errors = { 
                    1: 'Permission denied',
                    2: 'Position unavailable',
                    3: 'Request timeout'
                };
                console.log("Error: " + errors[error.code]);
            }


            function initialize() {

                var defaultCoords = { coords: { latitude: 34, longitude:-118 } }

                if ( typeof(localStorage) == 'undefined' || JSON == 'undefined' ) { //Check for required browser features
                    //Stop and return an error because you can't store results
                    $( "#contents" ).html('<h1>:-(</h1>');
                    alert('Your browser does not support HTML5 local storage, JSON, or both.')
                } else { //JSON & localStorage are present

                    if (localStorage.getItem("lat") == null || localStorage.getItem("lng") == null) {
                        foundLocation(defaultCoords)
                    } 

                    var lat = parseFloat(localStorage.getItem("lat"));
                    var lng = parseFloat(localStorage.getItem("lng"));
                    var location = new google.maps.LatLng(lat,lng)

                    //localStorage.removeItem("mapOptions"); //clear saved state from previous runs

                    options = localStorage.getItem("mapOptions");

                    if ( options == null ) {
                        console.log('There were no options in localStorage. Setting defaults.');
                        options = { 
                            center: location, 
                            zoom: 11,
                            disableDefaultUI: false,
                            disableDoubleClickZoom: false,
                            draggable: true
                            }; //default options
                    } else {
                        console.log('Getting options from localStorage:')
                        options = stringToMapOptions(options);
                    }

                    console.log(options)

                    runStateSwitch(options);

                }
            }


            function updateMap(mapOptions) {
                console.log('Map has been updated.')

                mapOptions.mapTypeId = google.maps.MapTypeId.ROADMAP;
                
                //display the map
                var map = new google.maps.Map(document.getElementById("map_canvas"),mapOptions);

                //enable the traffic layer
                var trafficLayer = new google.maps.TrafficLayer();
                trafficLayer.setMap(map); 

                return map
            }


            function mapOptionsToString(mapOpts) {
                var opts = JSON.parse(JSON.stringify(mapOpts)); //make a deep copy so you don't modify mapOpts in place
                opts.lat = mapOpts.center.lat();
                opts.lng = mapOpts.center.lng();
                delete opts.center;
                return JSON.stringify(opts)
            }


            function stringToMapOptions(optString) {
                var mapOpts = JSON.parse( optString );
                mapOpts.center = new google.maps.LatLng(mapOpts.lat, mapOpts.lng);
                delete mapOpts.lat;
                delete mapOpts.lng;
                return mapOpts
            }

            function runStateSwitch(mapOpts) {
                var map = updateMap(mapOpts)

                if (localStorage.getItem("mapOptions") == null) { //no stored data, state is clear
                    $( "#action" ).button({ label: 'Freeze View' });
                    $( "#action" ).click( function( event, ui ) { //Freeze: save the state and re-run the switch
                            console.log('Freezing view.')
                            newOpts = { 
                                center: map.getCenter(),
                                zoom: map.getZoom(),
                                disableDefaultUI: true,
                                disableDoubleClickZoom: true,
                                draggable: false
                            };
                            localStorage.setItem("mapOptions", mapOptionsToString(newOpts))
                            runStateSwitch(newOpts);
                    });
                } else { //data was found, state is frozen
                    $( "#action" ).button({ label: 'Release View' });
                    $( "#action" ).click( function( event, ui ) { //Release: clear the state and re-run the switch
                            console.log('Releasing view.')
                            newOpts = { 
                                center: map.getCenter(),
                                zoom: map.getZoom(),
                                disableDefaultUI: false, 
                                disableDoubleClickZoom: false,
                                draggable: true
                            };
                            localStorage.removeItem( "mapOptions" );
                            runStateSwitch(newOpts);
                    } );
                }
            }
        </script>
        <style type="text/css">
            html { height: 100% }
            body { height: 100%; margin: 0; padding: 0 }
            #upper_box { height: 0px; }
            #map_canvas { height: 100%; }
            #contents { text-align:center; width:100%; height:100% }
            #menu { position:absolute; z-index:1; bottom:10px; right:10px; text-align:right; width:100%; height:10% }
        </style>
    </head>
    
    <body onload="initialize()">
        <div id="contents">
            <div id="upper_box"></div>
            <div id="map_canvas"></div>
            <div id="menu">
                <button id="action"></button>
            </div>
        </div>
    </body>
</html>