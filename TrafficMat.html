<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
        <meta charset="utf-8">
        
        <meta name="apple-mobile-web-app-capable" content="yes">
        <link rel="apple-touch-icon-precomposed" href="apple-icon.png">
        <link rel="apple-touch-startup-image" href="apple-startup-image.png">
        
        <title>TrafficMat</title>
        <link rel="stylesheet" type="text/css" href="http://code.jquery.com/ui/1.9.2/themes/base/jquery-ui.css">
        <script src="http://maps.google.com/maps/api/js?sensor=false"></script>
        <script type="text/javascript" src="http://code.jquery.com/jquery-1.8.3.js"></script>
        <script type="text/javascript" src="http://code.jquery.com/ui/1.9.2/jquery-ui.js"></script>
        <script type="text/javascript">

            //global map and options objects - there should be only one of each
            var map = {} 
            var mapOptions = { //default values
                center: new google.maps.LatLng(44, -118),
                zoom: 11,
                disableDefaultUI: false,
                disableDoubleClickZoom: false,
                draggable: true,
                mapTypeId: google.maps.MapTypeId.ROADMAP
            };

            function getGeoLocation() {
                if (navigator.geolocation) {
                    console.log("Browser claims to support geolocation.")         
                    var timeoutVal = 10000; //10s timeout       
                    navigator.geolocation.getCurrentPosition(
                            foundLocation, 
                            displayError,
                            { enableHighAccuracy: true, timeout: timeoutVal, maximumAge: 0 })
                } else {
                    console.log("Geolocation is not supported by this browser");
                }
            }


            function foundLocation(position) {
                console.log(position.coords)
                var location = new google.maps.LatLng(position.coords.latitude,
                                                      position.coords.longitude);
                mapOptions.center = location; //update the location once it has been determined

                console.log(mapOptions)
                updateMap(mapOptions);
                markerOpts = {
                    draggable: false,
                    raiseOnDrag: false,
                    visible: true,
                    position: location,
                    map: map
                };
                marker = new google.maps.Marker(markerOpts);
                storeOptions();

            }


            function displayError(error) {
                var errors = { 
                    1: 'Permission denied',
                    2: 'Position unavailable',
                    3: 'Request timeout'
                };
                console.log("Error: " + errors[error.code]);
            }


            function updateMap(mapOptions) {
                console.log('Updating the map.')

                //display the map
                map = new google.maps.Map(document.getElementById("map_canvas"),mapOptions);

                //enable the traffic layer
                var trafficLayer = new google.maps.TrafficLayer();
                trafficLayer.setMap(map); 
            }


            function monitorState() {
                updateMap(mapOptions)

                if (localStorage.getItem("mapOptions") == null) { //no stored data, state should be unfrozen
                    $( "#action" ).button({ label: 'Freeze View' });
                    $( "#action" ).click( function ( event, ui ) {
                        $( "#action" ).unbind(); //necessary to avoid nested recursion
                        flipOptions();
                        storeOptions();
                        monitorState();
                        } );
                } else { //data was found, window should be frozen
                    $( "#action" ).button({ label: 'Release View' });
                    $( "#action" ).click( function ( event, ui ) {
                        $( "#action" ).unbind(); //necessary to avoid nested recursion
                        flipOptions();
                        releaseOptions();
                        monitorState();
                        } );
                }
            }


            function mapOptionsToString(mapOpts) {
                var opts = JSON.parse(JSON.stringify(mapOpts)); //make a deep copy so you don't modify mapOpts in place
                opts.lat = mapOpts.center.lat();
                opts.lng = mapOpts.center.lng();
                delete opts.center;
                return JSON.stringify(opts)
            }


            function stringToMapOptions(optString) {
                var opts = JSON.parse( optString );
                mapOptions.center = new google.maps.LatLng(opts.lat, opts.lng);
                mapOptions.zoom = opts.zoom;
                mapOptions.disableDefaultUI = opts.disableDefaultUI;
                mapOptions.disableDoubleClickZoom = opts.disableDoubleClickZoom;
                mapOptions.draggable = opts.draggable;
            }


            function flipOptions() {
                console.log('Updating mapOptions and flipping UI controls.')
                mapOptions.disableDefaultUI = !mapOptions.disableDefaultUI;
                mapOptions.disableDoubleClickZoom = !mapOptions.disableDoubleClickZoom;
                mapOptions.draggable = !mapOptions.draggable;
            }


            function storeOptions() {
                console.log('Saving mapOptions to localStorage.')
                mapOptions.center = map.getCenter();
                mapOptions.zoom = map.getZoom();
                localStorage.setItem( "mapOptions", mapOptionsToString(mapOptions) );
            }

            function releaseOptions() {
                console.log('Clearing localStorage.')
                mapOptions.center = map.getCenter();
                mapOptions.zoom = map.getZoom();
                localStorage.removeItem( "mapOptions" );
            }

            function loadOptions() {
                console.log('Reading localStorage.')
                opts = localStorage.getItem( "mapOptions" );
                mapOptions = stringToMapOptions(opts);
            }

            function initialize() {

                localStorage.removeItem("mapOptions");

                if (localStorage.getItem("mapOptions") != null) {
                    loadOptions();
                } else {
                    getGeoLocation();
                }


                monitorState();

            }

        </script>
        <style type="text/css">
            html { height: 100% }
            body { height: 100%; margin: 0; padding: 0 }
            #upper_box { height: 0px; }
            #map_canvas { height: 100%; }
            #contents { text-align:center; width:100%; height:100% }
            #menu { position:absolute; z-index:1; bottom:1em; right:10px; text-align:right; width:100%; height:10% }
        </style>
    </head>
    
    <body onload="initialize()">
        <div id="contents">
            <div id="upper_box"></div>
            <div id="map_canvas"></div>
            <div id="menu">
                <button id="action"></button>
            </div>
        </div>
    </body>
</html>