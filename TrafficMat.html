<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
        <meta charset="utf-8">
        
        <meta name="apple-mobile-web-app-capable" content="yes">
        <link rel="apple-touch-icon-precomposed" href="apple-icon.png">
        <link rel="apple-touch-startup-image" href="apple-startup-image.png">
        
        <title>TrafficMat</title>
        <link rel="stylesheet" type="text/css" href="http://code.jquery.com/ui/1.9.2/themes/base/jquery-ui.css">
        <script src="http://maps.google.com/maps/api/js?sensor=false"></script>
        <script type="text/javascript" src="http://code.jquery.com/jquery-1.8.3.js"></script>
        <script type="text/javascript" src="http://code.jquery.com/ui/1.9.2/jquery-ui.js"></script>
        <script type="text/javascript">

            /*********************** GLOBAL VARIABLES **********************/

            //global map and option objects - there should be only one of each
            var map, geoPosition, marker, timer;
            var mapOptions = { //default values
                center: new google.maps.LatLng(44, -118),
                zoom: 11,
                //disableDefaultUI: false,
                //disableDoubleClickZoom: false,
                //draggable: true,
                mapTypeId: google.maps.MapTypeId.ROADMAP
            };
            var markerOptions = {
                draggable: false,
                raiseOnDrag: false,
                visible: true,
                position: {},
                map: {}
            };


            /********************** HELPER FUNCTIONS **********************/

            function stringToMapOptions(optString) {
                console.log("Converting options string into object.")
                var optsCopy = JSON.parse( optString );
                optsCopy.center = $.extend(new google.maps.LatLng,optsCopy.center)
                return optsCopy
            }


            function mapOptionsToString(mapOpts) {
                console.log("Converting options object to string.")
                var optsCopy = $.extend(mapOpts,{}); //make a deep copy so you don't modify mapOpts in place
                console.log(optsCopy)
                return JSON.stringify(optsCopy);
            }


            function mapIsFrozen() {
                return localStorage.getItem("mapOptions") != null ? true : false
            }


            function hasGeoLocation() {
                return navigator.geolocation ? true : false
            }

          
            /************************* MAIN CODE **************************/

            function initialize() {

                //localStorage.removeItem("mapOptions"); // remove localStorage entry - used for debugging

                if ( mapIsFrozen() ) {
                    console.log("initialize(): Found mapOptions entry in localStorage.")
                    mapOptions = loadOptions();  // returns immediately & initially draws map with previously saved options
                } else {
                    console.log("initialize(): No data found in localStorage.")
                    getGeoLocation();
                }

                console.log("Continuing initialize() function...")

                // bind buttons for appearance
                $("#action").button()
                $("#refresh").button()

                updateMap();  // Draw the map
                bindUpdateButton();  // set up the traffic button label & callback function
                google.maps.event.trigger('idle');

            }


            function loadOptions() {
                console.log("loadOptions() attempting to load \"mapOptions\" from localStorage.")
                var tempOptions = stringToMapOptions(localStorage.getItem( "mapOptions" ))
                return $.extend(mapOptions, tempOptions)
            }


            function getGeoLocation() {
                if (hasGeoLocation() == true) {
                    console.log("getGeoLocation(): Browser claims to support geolocation. (This function is asynchronous.)")
                    
                    var timeoutVal = 10000;  //10s timeout       
                    navigator.geolocation.getCurrentPosition(
                            foundLocation, 
                            displayError,
                            { enableHighAccuracy: true, timeout: timeoutVal, maximumAge: 0 });
                } else {
                    console.log("getGeoLocation(): Geolocation is not supported by this browser.")
                }
            }


            function foundLocation(position) {
                console.log("Asynchronous function complete: getCurrentPosition() succeeded.")
                console.log("  foundLocation(): Broswer geolocation function succeeded, yielding coodrinates:");
                console.log(position.coords)
                
                geoPosition = new google.maps.LatLng(position.coords.latitude,
                                                      position.coords.longitude);
                mapOptions.center = geoPosition; //update the location once it has been determined

                if ( localStorage.getItem("mapOptions") == null ) {  // verify user hasn't already clicked save
                    updateMap();  // redraw the map using the geolocated coordinates
                    updateMarker(geoPosition);  // Place a marker at your current location
                    //storeOptions();  // Save current map options to localStorage
                }

            }

            function updateMarker(location) {
                if (marker) { marker.setMap(null); }
                console.log("updateMarker(): Drawing new marker on existing map.")
                markerOptions.position = location;
                markerOptions.map = map;
                marker = new google.maps.Marker(markerOptions);
            }


            function displayError(error) {
                console.log("Asynchronous function complete: getCurrentPosition() failed.")
                var errors = { 
                    1: 'Permission denied',
                    2: 'Position unavailable',
                    3: 'Request timeout'
                };
                console.log("  displayError(): " + errors[error.code]);
            }


            function updateMap() {
                console.log('updateMap():')
                
                if ( map == null || mapOptions.zoom != map.getZoom() ) {
                    console.log('  Drawing the map with the following options:')
                    console.log(mapOptions)

                    map = new google.maps.Map(document.getElementById("map_canvas"),mapOptions);
                    google.maps.event.addListener(map, 'idle', idleListener);

                    // These event listeners prevent the map from snapping back while you're still moving it.
                    google.maps.event.addListener(map, 'center_changed', resetTimer);
                    google.maps.event.addListener(map, 'zoom_changed', resetTimer);

                    updateTraffic();  // enable the traffic layer

                } else {
                    console.log('  Panning the map back to stored center point.')
                    map.panTo(mapOptions.center);
                }
            }


            function updateTraffic() {
                console.log("updateTraffic(): Drawing traffic layer.")
                var trafficLayer = new google.maps.TrafficLayer();
                trafficLayer.setMap(map);
            }


            function bindUpdateButton() {
                console.log("bindUpdateButton(): Binding label & click callback to \"Refresh\" button.")
                
                $( "#refresh" ).button({ label: 'Refresh' });
                $( "#refresh" ).click( function (event, ui) { 
                    console.log("click(): Refresh button callback triggered.")
                    getGeoLocation();
                    updateTraffic();
                     } )
            }


            function idleListener() {
                timer = (timer == null ? null : window.clearTimeout(timer));
                var nowCenter =  map.getCenter();
                var nowZoom = map.getZoom();
                var oldCenter = mapOptions.center;

                var dist = Math.abs(nowCenter.lat()-oldCenter.lat())+Math.abs(nowCenter.lng()-oldCenter.lng())

                if (dist <= .001 && nowZoom == mapOptions.zoom) {
                    if ( mapIsFrozen() ) {
                        console.log("idleListener(): Map is frozen; bind button to 'Unlock'.")
                        bindSaveButton("unlock");
                    } else {
                        console.log("idleListener(): Map is unlocked; bind button to 'Lock'.")
                        bindSaveButton("lock");
                    }
                } else if ( mapIsFrozen() ){
                    console.log("idleListener(): The map has moved; bind button to 'Lock'.")
                    bindSaveButton("lock");
                    snapBack(10);
                }    
                
            }

            
            function snapBack(countdown) {
                console.log('snapBack(): The map has moved or changed zoom.')

                if (countdown > 0) {
                    console.log(countdown)
                    $("#message").html("Recentering in " + countdown + "s...");
                    timer = window.setTimeout(function () { snapBack(countdown) }, 1000);  // 1 second delay
                    countdown--;
                } else if (countdown == 0) {
                    $("#message").html("");
                    updateMap();
                }
            }


            function bindSaveButton(state) {
                $("action").unbind()
                if (state == "lock") {
                    $("#action").button({label: 'Lock View'});
                    $("#action").click( function (event, ui) {
                        console.log("click(): Lock view state.")
                        $( "#action" ).unbind();  // necessary to avoid memory leak & nested recursion
                        clickToSave();
                        updateMap();
                        bindSaveButton("unlock");  // tail recursion to rebind & update label
                    });
                } else if (state == "unlock") {
                    $("#action").button({ label: 'Unlock View' });
                    $("#action").click( function ( event, ui ) {
                        console.log("click(): Unlock view state.")
                        $( "#action" ).unbind();  //necessary to avoid nested recursion
                        localStorage.removeItem("mapOptions");  // clear current settings
                        bindSaveButton("lock");  // tail recursion to rebind & update label
                    });
                } else {
                    console.log("bindSaveButton(): Invalid input.")
                }
            }


            function clickToSave() {
                console.log("clickToSave(): Saving map settings.")
                mapOptions.center = map.getCenter();
                mapOptions.zoom = map.getZoom();
                localStorage.setItem("mapOptions", mapOptionsToString(mapOptions));  // save current settings
                timer = (timer == null ? null : window.clearTimeout(timer)); // clear the timer (in case user clicks re-save)
            }

            function resetTimer() {
                timer = (timer == null ? null : window.clearTimeout(timer));
                $("#message").html("");
            }

            
            /************************* DEPRECATED *************************/

            function flipOptions() {
                console.log('Updating mapOptions and flipping UI controls.')
                mapOptions.disableDefaultUI = !mapOptions.disableDefaultUI;
                mapOptions.disableDoubleClickZoom = !mapOptions.disableDoubleClickZoom;
                mapOptions.draggable = !mapOptions.draggable;
            }


        </script>
        <style type="text/css">
            html { height:100% }
            body { height:100%; margin:0; padding:0 }
            #contents { width:100%; height:100% }
            #map_canvas { height:100% }
            #message { text-align:right; line-height:1.4; font-family: Verdana,Arial,sans-serif; font-size: 1em }
            #trafficMat_ui { position:absolute; z-index:1; right:10px; bottom:1em; width:auto; height:auto }
            #menu { bottom:0px }
        </style>
    </head>
    
    <body onload="initialize()">
        <div id="contents">
            <div id="map_canvas"></div>
            <div id="trafficMat_ui">
                <div id="message"></div>
                <div id="menu">
                    <button id="refresh"></button>
                    <button id="action"></button>
                </div>
            </div>
        </div>
    </body>
</html>